# 工作流中期变更和阶段管理

## 概述

用户可能在工作流执行过程中请求更改执行计划或阶段执行。本文档提供安全有效处理这些请求的指导。

---

## 工作流中期变更类型

### 1. 添加跳过的阶段

**场景**：用户想要添加原本跳过的阶段

**示例**："实际上，我想添加用户故事，即使我们跳过了那个阶段"

**处理方式**：
1. **确认请求**："您想要添加用户故事阶段。这将创建用户故事和角色。确认吗？"
2. **检查依赖关系**：验证所有前置阶段是否完成
3. **更新执行计划**：在 `execution-plan.md` 中添加阶段及理由
4. **更新状态**：在 `aidlc-state.md` 中将阶段标记为"PENDING"
5. **执行阶段**：遵循正常的阶段执行流程
6. **记录变更**：在 `audit.md` 中记录时间戳和原因

**考虑因素**：
- 可能需要更新后续阶段以受益于新工件
- 现有工件可能需要修订以纳入新信息
- 时间线将延长

---

### 2. 跳过计划阶段

**场景**：用户想要跳过计划执行的阶段

**示例**："让我们暂时跳过NFR设计阶段"

**处理方式**：
1. **确认请求**："您想要跳过NFR设计。这意味着不会纳入NFR模式或逻辑组件。确认吗？"
2. **警告影响**：解释将缺少什么以及潜在后果
3. **获得明确确认**：用户必须明确确认理解影响
4. **更新执行计划**：将阶段标记为"SKIPPED"并说明原因
5. **更新状态**：在 `aidlc-state.md` 中将阶段标记为"SKIPPED"
6. **调整后续阶段**：注意后续阶段可能需要手动设置
7. **记录变更**：在 `audit.md` 中记录时间戳和原因

**考虑因素**：
- 后续阶段可能失败或需要手动干预
- 用户承担缺失工件的责任
- 如需要可以稍后添加回来

---

### 3. 重启当前阶段

**场景**：用户对当前阶段结果不满意，想要重做

**示例**："我不喜欢这些用户故事。我们可以重新开始吗？"

**处理方式**：
1. **了解关注点**："您具体想要改变故事的哪些方面？"
2. **提供选项**：
   - **选项A**：修改现有工件（更快，保留部分工作）
   - **选项B**：完全重启（全新开始，更多时间）
3. **如果选择重启**：
   - 归档现有工件：`{artifact}.backup.{timestamp}`
   - 重置计划文件中的阶段复选框
   - 在 `aidlc-state.md` 中将阶段标记为"IN PROGRESS"
   - 清除阶段完成状态
   - 从头重新执行
4. **记录变更**：记录重启原因和将要改变的内容

**考虑因素**：
- 现有工作将丢失（但已备份）
- 可能需要重做依赖阶段
- 时间线将延长

---

### 4. 重启先前阶段

**场景**：用户想要回去重做已完成的阶段

**示例**："我想要改变我们之前做的架构决策"

**处理方式**：
1. **评估影响**：识别所有依赖于要重启阶段的阶段
2. **警告用户**："重启应用程序设计将需要重做：单元规划、单元生成、每单元设计（所有单元）、代码规划、代码生成。确认吗？"
3. **获得明确确认**：用户必须理解完整影响
4. **如果确认**：
   - 归档所有受影响的工件
   - 在 `aidlc-state.md` 中重置所有受影响的阶段
   - 清除所有受影响计划文件中的复选框
   - 返回到要重启的阶段
   - 从该点向前重新执行
5. **记录变更**：记录完整影响和重启原因

**考虑因素**：
- 需要大量返工
- 所有依赖阶段必须重做
- 时间线将显著延长
- 考虑修改是否比重启更好

---

### 5. 更改阶段深度

**场景**：用户想要更改当前或即将到来阶段的深度级别

**示例**："让我们做全面的需求分析而不是标准的"

**处理方式**：
1. **确认请求**："您想要将需求分析从标准深度改为全面深度。这将更彻底但需要更长时间。确认吗？"
2. **更新执行计划**：在 `workflow-planning.md` 中更改深度级别
3. **调整方法**：遵循该阶段的全面深度指导原则
4. **更新估算**：告知用户新的时间线估算
5. **记录变更**：记录深度变更和原因

**考虑因素**：
- 更深入 = 更多时间但更好质量
- 较浅 = 更快但可能遗漏细节
- 只能在阶段之前或期间更改，完成后不能更改

---

### 6. 暂停工作流

**场景**：用户需要暂停并稍后恢复

**示例**："我现在需要停止，明天继续"

**处理方式**：
1. **完成当前步骤**：如果可能，完成正在进行的当前步骤
2. **更新复选框**：用 [x] 标记所有已完成的步骤
3. **更新状态**：确保 `aidlc-state.md` 反映当前状态
4. **记录暂停**：在 `audit.md` 中记录暂停点
5. **提供恢复说明**："当您返回时，我将检测您的现有项目并提供从以下位置继续的选项：[当前阶段，当前步骤]"

**恢复时**：
1. **检测现有项目**：检查 `aidlc-state.md`
2. **加载上下文**：读取已完成阶段的所有工件
3. **显示状态**：显示当前阶段和下一步
4. **提供选项**：从中断处继续或回顾先前工作
5. **记录恢复**：在 `audit.md` 中记录恢复点

---

### 7. 更改架构决策

**场景**：用户想要从单体架构改为微服务（或相反）

**示例**："实际上，让我们做微服务而不是单体架构"

**处理方式**：
1. **评估当前进度**：确定工作流进行到哪里
2. **解释影响**：
   - 如果在单元规划之前：影响最小，只需更新决策
   - 如果在单元规划之后：必须重做单元规划、单元生成、所有每单元设计
   - 如果在代码生成之后：需要大量返工
3. **推荐方法**：
   - 工作流早期：从应用程序设计阶段重启
   - 工作流后期：考虑修改是否可行vs重启
4. **获得确认**：用户必须理解变更的完整范围
5. **执行变更**：对受影响的阶段遵循重启程序

**考虑因素**：
- 架构变更具有级联效应
- 工作流越早 = 越容易更改
- 工作流越晚 = 考虑成本vs收益

---

### 8. 添加/删除单元

**场景**：用户想要在单元生成后添加或删除单元

**示例**："我们需要将支付单元拆分为支付和计费"

**处理方式**：
1. **评估影响**：确定哪些单元已完成设计/代码
2. **解释后果**：
   - 添加单元：需要为新单元做完整的设计和代码
   - 删除单元：需要将功能重新分配给其他单元
   - 拆分单元：需要为两个结果单元重做设计和代码
3. **更新单元工件**：
   - 修改 `unit-of-work.md`
   - 更新 `unit-of-work-dependency.md`
   - 修订 `unit-of-work-story-map.md`
4. **重置受影响的单元**：将受影响的单元标记为需要重新设计
5. **执行变更**：对受影响的单元遵循正常的单元设计和代码流程

**考虑因素**：
- 影响这些单元的所有下游阶段
- 如果依赖关系改变可能影响其他单元
- 时间线影响取决于受影响的单元数量

---

## 处理变更的一般指导原则

### 进行变更前

1. **理解请求**：询问澄清问题，了解用户想要改变什么以及为什么
2. **评估影响**：识别所有受影响的阶段、工件和依赖关系
3. **解释后果**：清楚地传达需要重做什么以及时间线影响
4. **提供替代方案**：有时修改比重启更好
5. **获得明确确认**：用户必须理解并接受影响

### 变更期间

1. **归档现有工作**：在进行破坏性变更前始终备份
2. **更新所有跟踪**：保持 `aidlc-state.md`、计划文件和 `audit.md` 同步
3. **沟通进度**：让用户了解正在发生什么
4. **验证变更**：确保变更在所有工件中保持一致
5. **测试连续性**：验证变更后工作流可以顺利继续

### 变更后

1. **验证一致性**：检查所有工件是否与变更保持一致
2. **更新文档**：确保所有引用都已更新
3. **完整记录**：在 `audit.md` 中记录完整的变更历史
4. **与用户确认**：验证变更是否满足用户期望
5. **恢复工作流**：从新状态继续正常执行

---

## 变更请求决策树

```
用户请求变更
    |
    ├─ 是当前阶段吗？
    |   ├─ 是：可以修改或重启当前阶段
    |   └─ 否：转到下一个问题
    |
    ├─ 是已完成的阶段吗？
    |   ├─ 是：评估对依赖阶段的影响
    |   |   ├─ 低影响：修改并更新依赖项
    |   |   └─ 高影响：建议从该阶段重启
    |   └─ 否：转到下一个问题
    |
    ├─ 是添加跳过的阶段吗？
    |   ├─ 是：检查前置条件，添加到计划，执行
    |   └─ 否：转到下一个问题
    |
    ├─ 是跳过计划阶段吗？
    |   ├─ 是：警告影响，获得确认，跳过
    |   └─ 否：转到下一个问题
    |
    └─ 是更改深度级别吗？
        ├─ 是：更新计划，调整方法
        └─ 否：与用户澄清请求
```

---

## 记录要求

### 变更请求日志格式

```markdown
## 变更请求 - [阶段名称]
**时间戳**：[ISO时间戳]
**请求**：[用户想要改变什么]
**当前状态**：[我们在工作流中的位置]
**影响评估**：[将受到什么影响]
**用户确认**：[用户的明确确认]
**采取的行动**：[做了什么]
**受影响的工件**：[更改/重置的文件列表]

---
```

---

## 最佳实践

1. **始终确认**：在没有用户明确确认的情况下，永远不要进行破坏性变更
2. **解释影响**：用户在决定前需要理解后果
3. **提供选项**：有时有多种方式处理变更
4. **先归档**：在进行破坏性变更前始终备份
5. **更新一切**：保持所有跟踪文件同步
6. **彻底记录**：为审计跟踪记录所有变更
7. **事后验证**：确保工作流可以顺利继续
8. **保持灵活**：工作流应该适应用户需求，而不是强制执行僵化流程
