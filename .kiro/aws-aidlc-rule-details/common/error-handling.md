# 错误处理和恢复程序

## 一般错误处理原则

### 发生错误时
1. **识别错误**：清楚说明出了什么问题
2. **评估影响**：确定错误是阻塞性的还是可以绕过的
3. **沟通**：告知用户错误和选项
4. **提供解决方案**：提供解决或绕过错误的清晰步骤
5. **记录**：在 `audit.md` 中记录错误和解决方案

### 错误严重程度级别

**关键**：工作流无法继续
- 缺少必需的文件或工件
- 无法处理的无效用户输入
- 阻止文件操作的系统错误

**高**：阶段无法按计划完成
- 必需问题的不完整答案
- 矛盾的用户响应
- 先前阶段缺少依赖关系

**中等**：阶段可以通过变通方法继续
- 缺少可选工件
- 非关键验证失败
- 可能部分完成

**低**：不阻止进度的小问题
- 格式不一致
- 缺少可选信息
- 非阻塞警告

## 阶段特定错误处理

### 上下文评估错误

**错误**：无法读取工作区文件
- **原因**：权限问题，缺少目录
- **解决方案**：要求用户验证工作区路径和权限
- **变通方法**：仅使用用户提供的信息继续

**错误**：现有 `aidlc-state.md` 已损坏
- **原因**：手动编辑，先前运行不完整
- **解决方案**：询问用户是否要重新开始或尝试恢复
- **恢复**：创建备份，启动新状态文件

**错误**：无法确定所需阶段
- **原因**：用户信息不足
- **解决方案**：询问关于意图和范围的澄清问题
- **变通方法**：默认为全面执行计划

### 需求评估错误

**错误**：用户提供矛盾需求
- **原因**：理解不清楚，需求变化
- **解决方案**：创建后续问题解决矛盾
- **不要继续**：直到矛盾解决

**错误**：需求文档无法转换
- **原因**：不支持的格式，文件损坏
- **解决方案**：要求用户以支持的格式提供需求
- **变通方法**：使用用户的口头描述

**错误**：验证问题的不完整答案
- **原因**：用户跳过问题，不清楚要回答什么
- **解决方案**：突出显示未回答的问题，提供示例
- **不要继续**：直到所有必需问题都得到回答

### 故事开发错误

**错误**：无法将需求映射到故事
- **原因**：需求太模糊，缺少功能细节
- **解决方案**：返回需求评估进行澄清
- **变通方法**：基于可用信息创建故事，标记为不完整

**错误**：用户提供模糊的故事规划答案
- **原因**：选项不清楚，决策复杂
- **解决方案**：添加具有具体示例的后续问题
- **不要继续**：直到歧义解决

**错误**：故事生成计划有未完成的步骤
- **原因**：执行中断，步骤跳过
- **解决方案**：从第一个未完成的步骤恢复
- **恢复**：审查已完成的步骤，从检查点继续

### 应用程序设计错误

**错误**：架构决策不清楚或矛盾
- **原因**：模糊答案，冲突需求
- **解决方案**：添加后续问题澄清决策
- **不要继续**：直到决策清楚并记录

**错误**：无法确定服务/单元数量
- **原因**：关于边界的信息不足
- **解决方案**：询问关于部署、团队结构、扩展的具体问题
- **变通方法**：默认为单体，允许稍后更改

### 设计错误

**错误**：单元依赖关系是循环的
- **原因**：边界定义不良，紧耦合
- **解决方案**：识别循环依赖，建议重构
- **恢复**：修订单元边界以打破循环

**错误**：单元设计计划缺少步骤
- **原因**：计划生成不完整，模板错误
- **解决方案**：重新生成包含所有必需步骤的计划
- **恢复**：向现有计划添加缺少的步骤

**错误**：无法生成设计工件
- **原因**：缺少单元信息，需求不清楚
- **解决方案**：返回单元规划澄清单元定义
- **变通方法**：生成部分设计，标记空白

### NFR实现错误

**错误**：技术栈选择不兼容
- **原因**：冲突需求，平台限制
- **解决方案**：突出显示不兼容性，要求用户选择
- **不要继续**：直到做出兼容选择

**错误**：无法满足组织约束
- **原因**：网络限制，安全策略
- **解决方案**：记录约束，要求用户提供变通方法
- **升级**：可能需要人工干预进行设置

**错误**：NFR实现步骤需要人工操作
- **原因**：AI无法执行某些任务（网络配置，凭据）
- **解决方案**：清楚标记为**人工任务**，提供说明
- **等待**：用户确认后再继续

### 代码规划错误

**错误**：代码生成计划不完整
- **原因**：缺少设计工件，需求不清楚
- **解决方案**：返回设计阶段完成工件
- **恢复**：使用可用信息生成计划，标记空白

**错误**：单元依赖关系不满足
- **原因**：依赖单元尚未生成
- **解决方案**：重新排序生成序列以尊重依赖关系
- **变通方法**：使用存根依赖生成，稍后集成

### 代码生成错误

**错误**：无法为步骤生成代码
- **原因**：设计信息不足，需求不清楚
- **解决方案**：跳过步骤，记录为不完整，继续
- **恢复**：收集更多信息后返回步骤

**错误**：生成的代码有语法错误
- **原因**：模板问题，特定语言问题
- **解决方案**：修复语法错误，如需要重新生成
- **验证**：在继续之前验证代码编译

**错误**：测试生成失败
- **原因**：复杂逻辑，缺少测试框架设置
- **解决方案**：生成基本测试结构，标记为手动完成
- **变通方法**：不带测试继续，在运营阶段添加

### 运营错误

**错误**：无法确定构建工具
- **原因**：不寻常的项目结构，多个构建系统
- **解决方案**：要求用户指定构建工具和命令
- **变通方法**：提供通用说明，用户适应

**错误**：部署目标不清楚
- **原因**：多个环境，复杂基础设施
- **解决方案**：要求用户指定部署目标和方法
- **变通方法**：为常见平台提供说明

## 恢复程序

### 部分阶段完成

**场景**：阶段在执行中被中断

**恢复步骤**：
1. 加载阶段计划文件
2. 识别最后完成的步骤（最后的 [x] 复选框）
3. 从下一个未完成的步骤恢复
4. 验证所有先前步骤实际完成
5. 正常继续执行

### 损坏的状态文件

**场景**：`aidlc-state.md` 损坏或不一致

**恢复步骤**：
1. 创建备份：`aidlc-state.md.backup`
2. 询问用户实际在哪个阶段
3. 从头重新生成状态文件
4. 基于现有工件标记已完成的阶段
5. 从当前阶段恢复

### 缺少工件

**场景**：先前阶段的必需工件缺失

**恢复步骤**：
1. 识别缺少哪些工件
2. 确定是否可以重新生成
3. 如果可以：返回该阶段，重新生成工件
4. 如果不可以：要求用户手动提供信息
5. 在 `audit.md` 中记录空白

### 用户想要重启阶段

**场景**：用户对阶段结果不满意，想要重做

**恢复步骤**：
1. 确认用户想要重启（数据将丢失）
2. 归档现有工件：`{artifact}.backup`
3. 在 `aidlc-state.md` 中重置阶段状态
4. 清除计划文件中的阶段复选框
5. 从头重新执行阶段

### 用户想要跳过阶段

**场景**：用户想要跳过计划的阶段

**恢复步骤**：
1. 确认用户理解影响
2. 在 `audit.md` 中记录跳过原因
3. 在 `aidlc-state.md` 中将阶段标记为"SKIPPED"
4. 进入下一阶段
5. 注意：如果缺少依赖关系，可能在后续阶段引起问题

## 升级指导原则

### 何时寻求用户帮助

**立即**：
- 矛盾或模糊的用户输入
- 缺少必需信息
- AI无法解决的技术约束
- 需要业务判断的决策

**尝试解决后**：
- 同一步骤中的重复错误
- 复杂技术问题
- 不寻常的项目结构
- 与外部系统的集成

### 何时建议重新开始

**考虑重新开始如果**：
- 多个阶段有错误
- 状态文件严重损坏
- 用户无法提供缺失信息
- 工件在各阶段间不一致

## 会话恢复错误

### 恢复期间缺少工件

**错误**：先前阶段的必需工件缺失
- **原因**：文件被删除、移动或从未创建
- **解决方案**：
  1. 识别哪个阶段创建了缺失的工件
  2. 检查该阶段在 aidlc-state.md 中是否标记为完成
  3. 如果标记为完成但工件缺失：重新生成该阶段
  4. 如果未标记为完成：从该阶段恢复
- **恢复**：返回创建缺失工件的阶段并重新执行

**错误**：工件文件存在但为空或损坏
- **原因**：写入中断，手动编辑，文件系统问题
- **解决方案**：
  1. 创建损坏文件的备份
  2. 尝试从创建它的阶段重新生成
  3. 如果无法重新生成：要求用户提供信息重新创建
- **恢复**：重新执行创建工件的阶段

### 恢复期间状态不一致

**错误**：aidlc-state.md 显示阶段完成但工件不存在
- **原因**：状态文件已更新但工件生成失败
- **解决方案**：
  1. 在 aidlc-state.md 中将阶段标记为不完整
  2. 重新执行阶段以生成工件
  3. 在标记完成之前验证工件存在
- **恢复**：重置阶段状态并重新执行

**错误**：工件存在但 aidlc-state.md 显示阶段不完整
- **原因**：工件生成成功但状态更新失败
- **解决方案**：
  1. 验证工件完整且有效
  2. 更新 aidlc-state.md 将阶段标记为完成
  3. 进入下一阶段
- **恢复**：更新状态文件以反映实际完成情况

**错误**：aidlc-state.md 中多个阶段标记为"当前"
- **原因**：状态文件损坏，手动编辑
- **解决方案**：
  1. 审查工件以确定实际进度
  2. 询问用户实际在哪个阶段
  3. 更正 aidlc-state.md 显示单个当前阶段
- **恢复**：基于现有工件重建状态文件

### 上下文加载错误

**错误**：无法从先前阶段加载所需上下文
- **原因**：文件缺失，内容损坏，文件路径错误
- **解决方案**：
  1. 列出当前阶段需要哪些工件
  2. 检查哪些缺失或损坏
  3. 重新生成缺失的工件或要求用户提供信息
- **恢复**：在恢复当前阶段之前完成前置阶段

**错误**：加载的工件包含矛盾信息
- **原因**：手动编辑，多人工作，更新不完整
- **解决方案**：
  1. 识别矛盾并呈现给用户
  2. 询问用户哪个信息是正确的
  3. 更新工件以解决矛盾
- **恢复**：在继续之前调和矛盾

### 恢复最佳实践

1. **始终验证状态**：检查 aidlc-state.md 是否与实际工件匹配
2. **增量加载**：逐阶段加载工件，验证每个
3. **快速失败**：如果关键工件缺失立即停止
4. **清楚沟通**：告诉用户确切缺少什么以及为什么需要
5. **提供选项**：重新生成、手动提供或重新开始
6. **记录恢复**：在 audit.md 中记录所有恢复操作

**重新开始之前**：
1. 归档所有现有工作
2. 记录学到的经验
3. 识别要保留的内容
4. 获得用户确认
5. 创建新的执行计划

## 记录要求

### 错误记录格式

```markdown
## 错误 - [阶段名称]
**时间戳**：[ISO时间戳]
**错误类型**：[关键/高/中等/低]
**描述**：[出了什么问题]
**原因**：[为什么发生]
**解决方案**：[如何解决]
**影响**：[对工作流的影响]

---
```

### 恢复记录格式

```markdown
## 恢复 - [阶段名称]
**时间戳**：[ISO时间戳]
**问题**：[需要恢复什么]
**恢复步骤**：[做了什么]
**结果**：[恢复的结果]
**受影响的工件**：[文件列表]

---
```

## 预防最佳实践

1. **早期验证**：在开始工作之前检查输入和依赖关系
2. **经常检查点**：完成步骤后立即更新复选框
3. **清楚沟通**：解释您在做什么以及为什么
4. **提出问题**：不要假设 - 立即澄清歧义
5. **记录一切**：在 `audit.md` 中记录所有决策和变更
