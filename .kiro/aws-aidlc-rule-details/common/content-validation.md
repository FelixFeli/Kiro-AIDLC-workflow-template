# 内容验证规则

## 必须：文件创建前的内容验证

**关键**：所有生成的内容在写入文件之前必须经过验证，以防止解析错误。

## ASCII图表标准

**关键**：在创建任何包含ASCII图表的文件之前：

1. **加载** `common/ascii-diagram-standards.md`
2. **验证**每个图表：
   - 计算每行字符数（所有行必须相同宽度）
   - 仅使用：`+` `-` `|` `^` `v` `<` `>` 和空格
   - 不使用Unicode框线字符
   - 仅空格（不使用制表符）
3. **测试**对齐，通过验证框角垂直对齐

**参见 `common/ascii-diagram-standards.md` 获取模式和验证检查清单。**

## Mermaid图表验证

### 必需的验证步骤
1. **语法检查**：在文件创建前验证Mermaid语法
2. **字符转义**：确保特殊字符正确转义
3. **后备内容**：如果Mermaid验证失败，提供文本替代方案

### Mermaid验证规则
```markdown
## 在创建任何包含Mermaid图表的文件之前：

1. 检查节点ID中的无效字符（仅使用字母数字+下划线）
2. 转义标签中的特殊字符：" → \" 和 ' → \'
3. 验证流程图语法：节点连接必须有效
4. 通过简单验证测试图表解析

## 后备：如果Mermaid验证失败，使用基于文本的工作流表示
```

### 实现模式
```markdown
## 工作流可视化

### Mermaid图表（如果语法有效）
```mermaid
[已验证的图表内容]
```

### 文本替代方案（始终包含）
```
阶段1：启动
- 阶段1：工作区检测（已完成）
- 阶段2：需求分析（已完成）
[继续文本表示]
```

## 一般内容验证

### 创建前验证检查清单
- [ ] 验证嵌入的代码块（Mermaid、JSON、YAML）
- [ ] 检查特殊字符转义
- [ ] 验证markdown语法正确性
- [ ] 测试内容解析兼容性
- [ ] 为复杂元素包含后备内容

### 错误预防规则
1. **在使用工具/命令写入文件之前始终验证**：永远不要写入未验证的内容
2. **转义特殊字符**：特别是在图表和代码块中
3. **提供替代方案**：包含视觉内容的文本版本
4. **测试语法**：验证复杂内容结构

## 验证失败处理

### 验证失败时
1. **记录错误**：记录验证失败的内容
2. **使用后备内容**：切换到基于文本的替代方案
3. **继续工作流**：不要因内容验证失败而阻塞
4. **通知用户**：提及由于解析约束使用了简化内容
