# 构建和测试

**目的**：构建所有单元并执行综合测试策略

## 先决条件
- 所有单元的代码生成必须完成
- 所有代码工件必须已生成
- 项目已准备好进行构建和测试

---

## 步骤 1：分析测试需求

分析项目以确定适当的测试策略：
- **单元测试**：在代码生成期间已为每个单元生成
- **集成测试**：测试单元/服务之间的交互
- **性能测试**：负载、压力和可扩展性测试
- **端到端测试**：完整的用户工作流
- **合约测试**：服务间的 API 合约验证
- **安全测试**：漏洞扫描、渗透测试

---

## 步骤 2：生成构建指令

创建 `aidlc-docs/construction/build-and-test/build-instructions.md`：

```markdown
# 构建指令

## 先决条件
- **构建工具**：[工具名称和版本]
- **依赖关系**：[列出所有必需的依赖关系]
- **环境变量**：[列出必需的环境变量]
- **系统要求**：[操作系统、内存、磁盘空间]

## 构建步骤

### 1. 安装依赖关系
\`\`\`bash
[安装依赖关系的命令]
# 示例：npm install, mvn dependency:resolve, pip install -r requirements.txt
\`\`\`

### 2. 配置环境
\`\`\`bash
[设置环境的命令]
# 示例：导出变量、配置凭据
\`\`\`

### 3. 构建所有单元
\`\`\`bash
[构建所有单元的命令]
# 示例：mvn clean install, npm run build, brazil-build
\`\`\`

### 4. 验证构建成功
- **预期输出**：[描述成功构建输出]
- **构建工件**：[列出生成的工件和位置]
- **常见警告**：[注明任何可接受的警告]

## 故障排除

### 构建因依赖错误失败
- **原因**：[常见原因]
- **解决方案**：[逐步修复]

### 构建因编译错误失败
- **原因**：[常见原因]
- **解决方案**：[逐步修复]
```

---

## 步骤 3：生成单元测试执行指令

创建 `aidlc-docs/construction/build-and-test/unit-test-instructions.md`：

```markdown
# 单元测试执行

## 运行单元测试

### 1. 执行所有单元测试
\`\`\`bash
[运行所有单元测试的命令]
# 示例：mvn test, npm test, pytest tests/unit
\`\`\`

### 2. 审查测试结果
- **预期**：[X] 个测试通过，0 个失败
- **测试覆盖率**：[预期覆盖率百分比]
- **测试报告位置**：[测试报告路径]

### 3. 修复失败的测试
如果测试失败：
1. 在 [位置] 审查测试输出
2. 识别失败的测试用例
3. 修复代码问题
4. 重新运行测试直到全部通过
```

---

## 步骤 4：生成集成测试指令

创建 `aidlc-docs/construction/build-and-test/integration-test-instructions.md`：

```markdown
# 集成测试指令

## 目的
测试单元/服务之间的交互以确保它们正确协同工作。

## 测试场景

### 场景 1：[单元 A] → [单元 B] 集成
- **描述**：[正在测试的内容]
- **设置**：[所需的测试环境设置]
- **测试步骤**：[逐步测试执行]
- **预期结果**：[应该发生什么]
- **清理**：[测试后如何清理]

### 场景 2：[单元 B] → [单元 C] 集成
[类似结构]

## 设置集成测试环境

### 1. 启动所需服务
\`\`\`bash
[启动服务的命令]
# 示例：docker-compose up, start test database
\`\`\`

### 2. 配置服务端点
\`\`\`bash
[配置端点的命令]
# 示例：export API_URL=http://localhost:8080
\`\`\`

## 运行集成测试

### 1. 执行集成测试套件
\`\`\`bash
[运行集成测试的命令]
# 示例：mvn integration-test, npm run test:integration
\`\`\`

### 2. 验证服务交互
- **测试场景**：[列出关键集成测试场景]
- **预期结果**：[描述预期结果]
- **日志位置**：[检查日志的位置]

### 3. 清理
\`\`\`bash
[清理测试环境的命令]
# 示例：docker-compose down, stop test services
\`\`\`
```

---

## 步骤 5：生成性能测试指令（如适用）

创建 `aidlc-docs/construction/build-and-test/performance-test-instructions.md`：

```markdown
# 性能测试指令

## 目的
在负载下验证系统性能以确保满足要求。

## 性能要求
- **响应时间**：[Y]% 的请求 < [X]ms
- **吞吐量**：[X] 请求/秒
- **并发用户**：支持 [X] 个并发用户
- **错误率**：< [X]%

## 设置性能测试环境

### 1. 准备测试环境
\`\`\`bash
[设置性能测试的命令]
# 示例：扩展服务、配置负载均衡器
\`\`\`

### 2. 配置测试参数
- **测试持续时间**：[X] 分钟
- **加载时间**：[X] 秒
- **虚拟用户**：[X] 个用户

## 运行性能测试

### 1. 执行负载测试
\`\`\`bash
[运行负载测试的命令]
# 示例：jmeter -n -t test.jmx, k6 run script.js
\`\`\`

### 2. 执行压力测试
\`\`\`bash
[运行压力测试的命令]
# 示例：逐渐增加负载直到失败
\`\`\`

### 3. 分析性能结果
- **响应时间**：[实际 vs 预期]
- **吞吐量**：[实际 vs 预期]
- **错误率**：[实际 vs 预期]
- **瓶颈**：[识别的瓶颈]
- **结果位置**：[性能报告路径]

## 性能优化

如果性能不满足要求：
1. 从测试结果中识别瓶颈
2. 优化代码/查询/配置
3. 重新运行测试以验证改进
```

---

## 步骤 6：生成其他测试指令（根据需要）

根据项目要求，生成其他测试指令文件：

### 合约测试（用于微服务）
创建 `aidlc-docs/construction/build-and-test/contract-test-instructions.md`：
- 服务间的 API 合约验证
- 消费者驱动的合约测试
- 架构验证

### 安全测试
创建 `aidlc-docs/construction/build-and-test/security-test-instructions.md`：
- 漏洞扫描
- 依赖安全检查
- 身份验证/授权测试
- 输入验证测试

### 端到端测试
创建 `aidlc-docs/construction/build-and-test/e2e-test-instructions.md`：
- 完整用户工作流测试
- 跨服务场景
- UI 测试（如适用）

---

## 步骤 7：生成测试摘要

创建 `aidlc-docs/construction/build-and-test/build-and-test-summary.md`：

```markdown
# 构建和测试摘要

## 构建状态
- **构建工具**：[工具名称]
- **构建状态**：[成功/失败]
- **构建工件**：[列出工件]
- **构建时间**：[持续时间]

## 测试执行摘要

### 单元测试
- **总测试数**：[X]
- **通过**：[X]
- **失败**：[X]
- **覆盖率**：[X]%
- **状态**：[通过/失败]

### 集成测试
- **测试场景**：[X]
- **通过**：[X]
- **失败**：[X]
- **状态**：[通过/失败]

### 性能测试
- **响应时间**：[实际]（目标：[预期]）
- **吞吐量**：[实际]（目标：[预期]）
- **错误率**：[实际]（目标：[预期]）
- **状态**：[通过/失败]

### 其他测试
- **合约测试**：[通过/失败/不适用]
- **安全测试**：[通过/失败/不适用]
- **端到端测试**：[通过/失败/不适用]

## 总体状态
- **构建**：[成功/失败]
- **所有测试**：[通过/失败]
- **运营就绪**：[是/否]

## 下一步
[如果全部通过]：准备进入运营阶段进行部署规划
[如果有失败]：解决失败的测试并重新构建
```

---

## 步骤 8：更新状态跟踪

更新 `aidlc-docs/aidlc-state.md`：
- 标记构建和测试阶段完成
- 更新当前状态

---

## 步骤 9：向用户展示结果

展示综合消息：

```
"🔨 构建和测试完成！

**构建状态**：[成功/失败]

**测试结果**：
✅ 单元测试：[X] 个通过
✅ 集成测试：[X] 个场景通过
✅ 性能测试：[状态]
✅ 其他测试：[状态]

**生成的文件**：
1. ✅ build-instructions.md
2. ✅ unit-test-instructions.md
3. ✅ integration-test-instructions.md
4. ✅ performance-test-instructions.md（如适用）
5. ✅ [根据需要的其他测试文件]
6. ✅ build-and-test-summary.md

请在 aidlc-docs/construction/build-and-test/build-and-test-summary.md 中查看摘要

**准备进入运营阶段进行部署规划吗？**"
```

---

## 步骤 10：记录交互

**必须**：在 `aidlc-docs/audit.md` 中记录阶段完成：

```markdown
## 构建和测试阶段
**时间戳**：[ISO 时间戳]
**构建状态**：[成功/失败]
**测试状态**：[通过/失败]
**生成的文件**：
- build-instructions.md
- unit-test-instructions.md
- integration-test-instructions.md
- performance-test-instructions.md
- build-and-test-summary.md

---
```
