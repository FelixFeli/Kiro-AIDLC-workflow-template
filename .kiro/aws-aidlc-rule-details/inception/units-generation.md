# 单元生成 - 详细步骤

## 概述
此阶段通过两个集成部分将系统分解为可管理的工作单元：
- **第 1 部分 - 规划**：创建分解计划和问题，收集答案，分析歧义，获得批准
- **第 2 部分 - 生成**：执行批准的计划以生成单元工件

**定义**：工作单元是为开发目的而进行的故事逻辑分组。对于微服务，每个单元成为独立可部署的服务。对于单体应用，单个单元代表具有逻辑模块的整个应用程序。

**术语**：对独立可部署的组件使用"服务"，对服务内的逻辑分组使用"模块"，对规划上下文使用"工作单元"。

## 先决条件
- 上下文评估必须完成
- 推荐需求评估（提供功能范围）
- 推荐故事开发（故事映射到单元）
- 应用程序设计阶段必需（确定组件、方法和服务）
- 执行计划必须指示应执行设计阶段

---

# 第 1 部分：规划

## 步骤 1：创建工作单元计划
- 生成带复选框 [] 的计划，将系统分解为工作单元
- 专注于将系统分解为可管理的开发单元
- 每个步骤和子步骤都应该有复选框 []

## 步骤 2：在计划中包含必需的单元工件
**始终**在单元计划中包含这些必需的工件：
- [ ] 生成 `aidlc-docs/inception/application-design/unit-of-work.md`，包含单元定义和职责
- [ ] 生成 `aidlc-docs/inception/application-design/unit-of-work-dependency.md`，包含依赖矩阵
- [ ] 生成 `aidlc-docs/inception/application-design/unit-of-work-story-map.md`，将故事映射到单元
- [ ] **仅绿地项目**：在 `unit-of-work.md` 中记录代码组织策略（参见 code-generation.md 的结构模式）
- [ ] 验证单元边界和依赖关系
- [ ] 确保所有故事都分配给单元

## 步骤 3：生成上下文相关的问题
**指令**：分析需求、故事和应用程序设计，仅生成与此特定分解问题相关的问题。使用以下类别作为灵感，而不是强制性检查清单。如果不适用，跳过整个类别。

- 使用 [Answer]: 标签格式嵌入问题
- 专注于此上下文特定的歧义和缺失信息
- 仅在决策需要用户输入时生成问题

**示例问题类别**（根据需要调整）：
- **故事分组** - 仅当存在多个故事且分组策略不清楚时
- **依赖关系** - 仅当可能有多个单元且集成方法模糊时
- **团队对齐** - 仅当团队结构或所有权不清楚时
- **技术考虑** - 仅当跨单元的可扩展性/部署要求不同时
- **业务领域** - 仅当领域边界或有界上下文不清楚时
- **代码组织（仅绿地多单元）** - 询问部署模型和目录结构偏好

## 步骤 4：存储 UOW 计划
- 保存为 `aidlc-docs/inception/plans/unit-of-work-plan.md`
- 包含所有用户输入的 [Answer]: 标签
- 确保计划涵盖系统分解的所有方面

## 步骤 5：请求用户输入
- 要求用户直接在计划文档中填写 [Answer]: 标签
- 强调分解决策的重要性
- 提供完成 [Answer]: 标签的明确说明

## 步骤 6：收集答案
- 等待用户使用文档中的 [Answer]: 标签提供所有问题的答案
- 在所有 [Answer]: 标签完成之前不要继续
- 审查文档以确保没有 [Answer]: 标签留空

## 步骤 7：分析答案（必需）
在继续之前，您必须仔细审查所有用户答案：
- **模糊或含糊的回应**："混合"、"介于之间"、"不确定"、"取决于"
- **未定义的标准或术语**：引用没有明确定义的概念
- **矛盾的答案**：相互冲突的回应
- **缺失的生成细节**：缺乏具体指导的答案
- **组合选项的答案**：在没有明确决策规则的情况下合并不同方法的回应

## 步骤 8：必需的后续问题
如果步骤 7 中的分析揭示任何模糊答案，您必须：
- 使用 [Answer]: 标签向计划文档添加具体的后续问题
- 在所有歧义解决之前不要继续批准
- 必需后续问题的示例：
  - "您提到了'A 和 B 的混合' - 什么具体标准应该决定何时使用 A 与 B？"
  - "您说'介于 A 和 B 之间' - 您能定义确切的中间方法吗？"
  - "您表示'不确定' - 什么额外信息会帮助您决定？"
  - "您提到'取决于复杂性' - 您如何定义复杂性级别？"

## 步骤 9：请求批准
- 询问："**工作单元计划完成。请审查 aidlc-docs/inception/plans/unit-of-work-plan.md 中的计划。准备继续生成吗？**"
- 在用户确认之前不要继续

## 步骤 10：记录批准
- 在 audit.md 中记录提示和响应，包含时间戳
- 使用 ISO 8601 时间戳格式
- 包含完整的批准提示文本

## 步骤 11：更新进度
- 在 aidlc-state.md 中标记单元规划完成
- 更新"当前状态"部分
- 准备过渡到单元生成

---

# 第 2 部分：生成

## 步骤 12：加载工作单元计划
- [ ] 从 `aidlc-docs/inception/plans/unit-of-work-plan.md` 读取完整计划
- [ ] 识别下一个未完成的步骤（第一个 [ ] 复选框）
- [ ] 为该步骤加载上下文和需求

## 步骤 13：执行当前步骤
- [ ] 准确执行当前步骤描述的内容
- [ ] 按计划中指定的生成单元工件
- [ ] 遵循规划中批准的分解方法
- [ ] 使用计划中指定的标准和边界

## 步骤 14：更新进度
- [ ] 在工作单元计划中将完成的步骤标记为 [x]
- [ ] 更新 `aidlc-docs/aidlc-state.md` 当前状态
- [ ] 保存所有生成的工件

## 步骤 15：继续或完成
- [ ] 如果还有更多步骤，返回步骤 12
- [ ] 如果所有步骤完成，验证单元已准备好进行设计阶段
- [ ] 将单元生成阶段标记为完成

## 步骤 16：展示完成消息

```markdown
# 🔧 单元生成完成

[AI 生成的单元和分解创建摘要，以项目符号形式]

> **📋 <u>**需要审查：**</u>**  
> 请检查单元生成工件：`aidlc-docs/inception/application-design/`

> **🚀 <u>**下一步？**</u>**
>
> **您可以：**
>
> 🔧 **请求变更** - 如需要，要求修改单元生成
> ✅ **批准并继续** - 批准单元并继续到 **构建阶段**
```

## 步骤 17：等待明确批准
- 在用户明确批准单元生成之前不要继续
- 批准必须清楚明确
- 如果用户请求变更，更新单元并重复批准过程

## 步骤 18：记录批准响应
- 在 `aidlc-docs/audit.md` 中记录用户的批准响应和时间戳
- 包含确切的用户响应文本
- 清楚标记批准状态

## 步骤 19：更新进度
- 在 `aidlc-docs/aidlc-state.md` 中标记单元生成阶段完成
- 更新"当前状态"部分
- 准备过渡到构建阶段

---

## 关键规则

### 规划阶段规则
- 仅生成上下文相关的问题
- 对所有问题使用 [Answer]: 标签格式
- 在继续之前分析所有答案的歧义
- 通过后续问题解决所有歧义
- 在生成之前获得明确的用户批准

### 生成阶段规则
- **无硬编码逻辑**：仅执行工作单元计划中写的内容
- **严格遵循计划**：不要偏离步骤序列
- **更新复选框**：完成每个步骤后立即标记 [x]
- **使用批准的方法**：遵循规划中的分解方法
- **验证完成**：在继续之前确保所有单元工件完整

## 完成标准
- 所有规划问题已回答，歧义已解决
- 获得用户对计划的批准
- 工作单元计划中的所有步骤标记为 [x]
- 根据计划生成所有单元工件：
  - `unit-of-work.md` 包含单元定义
  - `unit-of-work-dependency.md` 包含依赖矩阵
  - `unit-of-work-story-map.md` 包含故事映射
- 单元已验证并准备好进行每单元设计阶段
